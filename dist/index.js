// @bun
var{file:C,write:KQ,gunzipSync:MQ,serve:OQ,deflateSync:UQ}=globalThis.Bun;import{config as DQ}from"dotenv";var EQ=(Q)=>Array.from({length:Q},($,H)=>H),HQ="ABCDEFGHIJKLMNOPQRSTUVWXYZ",NQ="abcdefghijklmnopqrstuvwxyz",GQ=EQ(10).join(""),PQ=new RegExp(/(\d+)(\d*)/,"m");var VQ=(Q)=>{return!isNaN(parseFloat(Q))&&isFinite(Q)},x=(Q)=>{return typeof Q==="object"&&Q!==null&&!Array.isArray(Q)},c=(Q)=>{return Q instanceof Uint8Array||Q instanceof ArrayBuffer||typeof Q==="string"};var h=(Q)=>typeof Q==="boolean",w=(Q)=>typeof Q==="string",_=(Q)=>Array.isArray(Q);var{keys:d,entries:J,hasOwn:xQ}=Object;var R=Object.assign,Y=(Q)=>{return Object.keys(Q).length},b=(Q,$)=>Q.replace(new RegExp(`^${$}|${$}$`,"g"),"");var L=(Q)=>JSON.stringify(Q),o=(Q)=>{return JSON.parse(Q)};var n=(Q,$)=>{let[H,E]=$.replace(/bytes=/,"").split("-").map((N,G)=>{let V=parseInt(N,10);return isNaN(V)?G===0?0:Q-1:V});return[H,E,Q]},f=(Q,$)=>{return Q.reduce((H,E,N)=>{return H[E]=$[N],H},{})},p=(Q,$=!1)=>{if(VQ(Q))return Number.isInteger(Q)?[Q,"int"]:[Q,"float"];if($&&Q.includes("."))return[Q,"file"];if(Q==="/")return[Q,"-"];if(Q.length===36&&Q.match(/\-/g)?.length===4)return[Q,"uuid"];return[Q,"string"]};function y(Q){let $=Q.startsWith("/")?Q:"/"+Q,H=$.match(/(?<=\/)[^/].*?(?=\/|$)/g)??["/"],[E,N]=H.reduce(([G,V],Z)=>{if(Z.includes("<")){let B=Z.match(/(?<=<)[^/].*?(?=>|$)/g);if(B?.length){let[M,O]=B[0].split(":");G.push(M),V.push(O)}}else G.push(Z);return[G,V]},[[],[]]);if($.endsWith("/")&&$.length>1)E.push("/");return{parsed:E,args:N}}class W{date;constructor(Q){this.date=Q?new Date(Q):new Date}delta(Q=null,$=!1){let H=W.delta(this.date.getTime(),Q);return $?new Date(H):H}timed(Q){if(!Q)return this.date;return[["year","FullYear"],["month","Month"],["day","Date"],["hour","Hours"],["minute","Minutes"],["second","Seconds"]].reduce((H,[E,N])=>{let G=Q[E];return G?new Date(H[`set${N}`](H[`get${N}`]()+G)):H},new Date(this.date))}static delta(Q,$=null){return $?$-Q:Q-Date.now()}static get now(){return Date.now()}}var j=(Q)=>{let $=HQ+NQ;return Array.from({length:Q},(H,E)=>$+(E?GQ:"")).reduce((H,E)=>{return H+=E.charAt(Math.floor(Math.random()*E.length))},"")};import{Auth as qQ,ServerSide as IQ,JWTInterface as JQ}from"authored";import{mkdirSync as ZQ,writeFileSync as BQ}from"fs";var l=(Q,$="")=>{try{return BQ(Q,$,{flag:"wx"}),!0}catch(H){return!1}},i=(Q)=>{return ZQ(Q,{recursive:!0}),!0};class YQ{static set p(Q){if(_(Q))console.log(...Q);else console.log(Q)}static rand(Q=6,$){if($)return Math.round(Math.random()*($-Q)+Q);return Math.floor(Math.random()*Q)+1-1}}var I={attr:(Q)=>{return J(Q).reduce(($,[H,E])=>{return $.push(h(E)?H:`${H}="${E}"`),$},[""]).join(" ")},head:(Q)=>{if(Q)return J(Q).reduce(($,[H,E])=>{if(w(E))$.push(`<${H}>${E}</${H}>`);else if(_(E)){let N=E.reduce((G,V)=>{let Z="";if(H=="script"){let B="";if("importmap"in V)V.type="importmap",B=JSON.stringify(V.importmap),delete V.importmap;else if("body"in V)B=V.body,delete V.body;Z=`${B}</${H}>`}return G.push(`<${H}${I.attr(V)}>${Z}`),G},[]);$.push(...N)}return $},[]);return[]},cookie:(Q,$="",{maxAge:H,expires:E,path:N,domain:G,secure:V,httpOnly:Z,sameSite:B})=>{if(H instanceof Date)H=H.getSeconds();if(E instanceof Date)E=E.toUTCString();else if(E===0)E=new Date().toUTCString();return[["Domain",G],["Expires",E],["Max-Age",H],["Secure",V],["HttpOnly",Z],["Path",N],["SameSite",B]].reduce((O,[D,K])=>{if(K!==void 0)O.push(`${D}=${K}`);return O},[`${Q}=${$}`]).join("; ")},html:(Q,$,H,E)=>{let N=$,G=`<!DOCTYPE html><html lang="${H}">`;return G+=`<head>${N}</head>`,G+=E?E:`<body id="${j(5)}">${Q}</body>`,G+="</html>",G}},a={tls:(Q)=>{return J(process.env).filter(($)=>{if($[0].startsWith("TLS_"))return $}).reduce(($,H)=>{let[E,N]=H;if(N){let G=E.replace("TLS_","").toLowerCase();$[G]=C(Q+"/"+N)}return $},{})},mimeType:(Q)=>{return C(Q).type}};function gQ(...Q){let[$,H,E]=Q,N=E.value;return E.value=async function(G={}){if("session"in G&&G.session){let V=[G];return N.apply(this,V)}return{error:401}},E}function mQ(...Q){let[$,H,E]=Q,N=E.value;return E.value=async function(G={}){if("jwt"in G){let V=[G];return N.apply(this,V)}return{error:401}},E}function vQ(...Q){let[$,H,E]=Q,N=E.value;return E.value=async function(G={}){if("jwt_refresh"in G){let V=[G];return N.apply(this,V)}return{error:401}},E}class e{Q;$;formData;headers;url;method;__cookies={};constructor(Q,$){this.req=Q;this.server=$;this.headers=Q.headers??new Headers,this.url=new URL(Q.url),this.method=this.req.method.toLowerCase()}get auth(){let Q=this.headers.get("authorization");if(Q){let[$,H]=Q.split(" ",2);if($.trim()=="Bearer")return H.trim()}}get accept(){return this.headers.get("accept")}get contentType(){return this.headers.get("content-type")}get cookies(){if(!Y(this.__cookies)){let Q=this.headers.get("cookie");if(Q)this.__cookies=Q.split(";").reduce(($,H)=>{let[E,N]=H.trim().split(/=(.*)/s);return $[E]=N,$},{})}return this.__cookies}async form(){if(this.isForm){if(!this.formData)this.formData=await this.req.formData();return this.formData}return new FormData}get ip(){return this.server?.requestIP(this.req)??""}get isForm(){let Q=this.contentType;return Q?Q.indexOf("multipart/form-data")>=0||Q.indexOf("x-www-form-urlencoded")>=0:!1}get isEventStream(){return this.accept?.includes("text/event-stream")}get path(){return this.url.pathname}get parsed(){let{parsed:Q}=y(this.path);return Q}get searchParams(){return this.url.searchParams}get range(){return this.headers.get("range")??void 0}async authgroup(){let{cookies:Q,auth:$}=this,H=Q.session??"",E=$??"",N="",G=this.isForm?await this.form():void 0;if(G){let V=G.get("refresh_token");N=V?V.toString():""}return{sid:H,jwtv:E,refreshjwt:N}}get upgrade(){return this.headers.get("upgrade")}upgraded(Q={}){return this.server?.upgrade(this.req,Q)}}class g{headattr={};get head(){return this.headattr}set head(Q){J(Q).forEach(([$,H])=>{if($=="title"||$=="base")this.headattr[$]=H;else if(!($ in this.headattr))this.headattr[$]=H;else this.headattr[$].push(...H)})}}class T{Q;intervalID=[];constructor(Q){this.ctrl=Q}push(Q,$=2000){if(this.ctrl){let H=setInterval(()=>{let{id:E,retry:N,data:G,event:V,end:Z}=Q();if(this.ctrl){let B=Z?"end":G;if(N){let M=N>2000?N:2000;this.ctrl.enqueue(`retry: ${M}
`)}if(this.ctrl.enqueue(`id: ${E}
`),V&&this.ctrl.enqueue(`event: ${V}
`),typeof B=="object")this.ctrl.enqueue("data: "+JSON.stringify(B)+`

`);else this.ctrl.enqueue("data: "+B+`

`);Z&&this.close()}},$>1000?$:1000);this.intervalID.push(H)}}close(){if(this.intervalID.length)this.intervalID.forEach((Q)=>{clearInterval(Q)}),this.intervalID=[];this.ctrl?.close()}}class AQ extends g{Q;lang="en";status;stream;headers={};__session;__jwt;constructor(Q){super();this.request=Q}get session(){if(!this.__session)this.__session=U.session.new;return this.__session}set session(Q){this.__session=Q}get jwt(){if(!this.__jwt)this.__jwt=U.jwt.new;return this.__jwt}set jwt(Q){this.__jwt=Q}get timedJWT(){return U.jwtInt.jwt()}set header(Q){R(this.headers,Q)}get header(){return this.headers}set type(Q){this.header={"Content-Type":Q}}setCookie({key:Q,val:$,path:H="/",days:E=31,httpOnly:N=!1}){let G=I.cookie(Q,$,{expires:new W().timed({day:E}),path:H,httpOnly:N,sameSite:"Strict"});this.header={"Set-Cookie":G}}deleteCookie(Q){this.setCookie({key:Q,val:"",days:0})}}var X=new Map;class LQ{Q;ws;path;id;broadcasting=!1;max=0;constructor(Q){this.request=Q;this.path=Q.path,this.id=j(10)}async open(){}async message(Q){}async close(Q,$){}set send(Q){if(Q)if(this.broadcasting)this.ws.publish(this.path,Q);else this.ws.send(Q)}get role(){let Q=X.get(this.path);if(Q&&this.id in Q)return Q[this.id].role}}var t=new Map,r=new Map,s=new Map,k=new Map,jQ=["string","int","float","file","uuid"];class z{_class;url;parsedURL;args=[];isFile;isWS;fileType="text/plain";bytes;maxClient=0;withSession=!1;preload=!1;broadcastWSS=!1;constructor({url:Q,_class:$=null,isFile:H=!1,withSession:E=!1,preload:N=!1,isWS:G=!1}){let{parsed:V,args:Z}=y(Q);if(this.url=Q,this.parsedURL=V,this.args=Z,this._class=$,this.isFile=H,this.isWS=G,H)this.preload=N,this.withSession=E,this.fileType=a.mimeType(Q)}loadbytes(Q){if(this.preload)C(Q+this.url).bytes().then(($)=>{this.bytes=$}).catch(($)=>{throw`error: can't preload ${this.url}. File not found.`})}}class F{Yurl;status=404;x_args;headers=new Headers({"Content-Type":"text/plain"});constructor({Yurl:Q,status:$=404,headers:H={}},E){if(R(this,{Yurl:Q,status:$}),H)this.header=H;this.x_args=E??[]}set header(Q){J(Q).forEach(([$,H])=>{this.headers.set($,H)})}set type(Q){this.headers.set("Content-Type",Q)}gzip(Q){let $=UQ(Q);return this.header={"Content-Length":$.byteLength.toString(),"Content-Encoding":"deflate"},$}}class q{Q;static router;apt="";headstr="";constructor(Q){this.id=Q}set route(Q){let{url:$,isFile:H,isWS:E,parsedURL:N,_class:G}=Q,V=E?s:H?r:t,Z=L(N);if(!V.get(Z))V.set(Z,Q);else if(!H)throw`URL: ${$} already used in class < ${G.name} >`}folder(Q,$={}){Q=b(Q,"."),Q=b(Q,"/"),k.set(Q,$)}isFile(Q,{parsed:$,_path:H}){if(Q){let E=$.slice(0,-1).join("/"),N=!1;if([...k.keys()].some((Z)=>{if(E.startsWith(Z)){let B=k.get(Z);N=B?!!B.session:!1}return E.startsWith(Z)}))return new F({Yurl:new z({url:`.${H}`,isFile:!0,withSession:N}),status:200})}return new F({})}get({parsed:Q,wss:$=!1,_path:H}){let E=!1,N=Q.slice().pop();if(N)E=p(N,!0).pop()=="file";let G=[],V=$?s:E?r:t,Z=V.get(L(Q));if(!Z){let B=[];for(let M of V.keys()){let O=o(M),D=O.length;if(Q.length===D)for(let K=0;K<D;K++)if(O[K]===Q[K])B[K]=Q[K];else{let A=O[K];if(jQ.includes(A))B[K]=O[K],G.push(Q[K])}}Z=V.get(L(B))}if(Z)return new F({Yurl:Z,status:200},G);else return this.isFile(E,{parsed:Q,_path:H})}static get init(){if(!q.router)q.router=new q(j(7));return q.router}}class S{Q;$;constructor(Q,$={}){this.app=Q;this.data=$}_head(Q){if(!Q.startsWith("."))Q="."+Q;return`<script type="module">import x from "${Q}";x.ctx(${L(this.data)});</script>`}async render(Q,$){if(w(this.app)){let H=this._head(this.app);return I.html("",Q+H,$)}else if("ssr"in this.app){let H=await this.app.ssr(this.data);return I.html("",Q+H.script,$,H.body)}return I.html("",Q,$)}}class QQ{session;jwt;jwtInt;constructor(){this.jwtInt=new JQ}init(Q){this.session=Q.session,this.jwt=Q.jwt}}var U=new QQ;class u{req;X;Y;isWSS;x_args;method;apt;constructor(Q,$){this.req=new e(Q,$);let{upgrade:H,parsed:E,method:N,path:G}=this.req;this.isWSS=!!H,this.X=q.init.get({parsed:E,wss:this.isWSS,_path:G}),this.apt=q.init.apt;let{Yurl:V,x_args:Z}=this.X;this.Y=V,this.x_args=Z,this.method=N}push(Q="",$){let{status:H,headers:E}=this.X;return new Response(Q,{status:$??H,headers:E})}file(Q,$,H){this.X.type=H;let E=this.req.range;if(E){let[N,G,V]=n($,E);return this.X.header={"Content-Range":`bytes ${N}-${G}/${V}`,"Content-Length":$.toString()},this.X.status=206,Q.slice(N,G+1)}else return this.X.header={"Cache-Control":"max-age=86400, must-revalidate"},c(Q)?this.X.gzip(Q):Q}async isFile(){let{url:Q,bytes:$,fileType:H}=this.Y,E=Q+" file note found.";if($)E=this.file($,$.byteLength,H);else{let V=C(this.apt+Q);try{let Z=H.startsWith("video/");E=this.file(Z?V:await V.bytes(),V.size,H)}catch(Z){this.X.status=404}}let{headers:N,status:G}=this.X;return new Response(E,{headers:N,status:G})}async upgrade(){let{Yurl:Q,headers:$,x_args:H}=this.X,E=500;if(Q){let{_class:N,args:G,broadcastWSS:V,maxClient:Z,withSession:B}=Q;if(N){let M=!0,O=f(G,H),D=new N(this.req),{sid:K}=await this.req.authgroup();if(B)if(K){let v=await U.session.openSession(K);if(!v.new)D.session=v;else E=401,M=!1}else E=401,M=!1;D.broadcasting=V,D.max=Z;let A=D.path,P=X.get(A);if(!P)X.set(A,{});P=X.get(A)??{};let $Q=Y(P);if(M&&Z&&$Q>=Z)M=!1;M&&this.req.upgraded({data:{wclass:D,z_args:O,client:P}})}}return new Response("upgrade error",{status:E,headers:$})}async auth(Q,$){let H={},{sid:E,jwtv:N,refreshjwt:G}=await this.req.authgroup();if(E){if(Q.session=await U.session.openSession(E),!Q.session.new)H.session=!0}if(N){if(Q.jwt=U.jwtInt.open(N,{hours:6}),!Q.jwt.new)H.jwt=!0;if(G){if(!(await U.jwt.openSession(G)).new)H.jwt_refresh=!0}}if(Y(H))R($,H);return}async ctx(Q,$,H,E){if(Q instanceof Response)return this.X.status=Q.status,this.X.header=Q.headers.toJSON(),await Q.arrayBuffer();else if(x(Q)&&!(Q instanceof S))return this.X.type="application/json",this.X.gzip(JSON.stringify(Q));else{if(this.X.type="text/html",Q instanceof S)return this.X.gzip(await Q.render($,H));let N=I.html(Q,$,H);return this.X.gzip(N)}}async jwt(Q){let{jwtv:$,refreshjwt:H}=await this.req.authgroup(),E={},N=(V)=>{this.X.status=403,E={error:V}},G=async(V)=>{let Z=U.jwtInt.save(V);V.access_token=Z,await U.jwt.saveSession(V,this.X.headers),E={access_token:Z,refresh_token:V.sid,status:"ok"}};if(H){let V=await U.jwt.openSession(H),Z=V.data.access_token;if($==Z)if(U.jwtInt.verify(Z,{days:5}))await G(V);else await U.jwt.saveSession(V,void 0,!0),N("expired refresh_token");else N("tokens don't match.")}else if(!$&&Q.modified)await G(Q);else this.X.status=204;return this.X.type="application/json",this.X.gzip(JSON.stringify(E))}async estream(Q,$,H){this.X.header={"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"},$.stream=new T;let E=await $.eventStream(H);if(x(E)&&"error"in E)return this.X.status=E.error,"";return new ReadableStream({async start(G){$.stream=new T(G),await $.eventStream(H),Q.req.signal.addEventListener("abort",()=>{if($.stream?.close(),$.stream?.intervalID.length)G.close()})}})}async response(){if(this.isWSS)return await this.upgrade();if(this.Y){let{isFile:Q,_class:$,args:H}=this.Y;if(Q)return this.isFile();else if($){let E=new $(this.req),N=f(H,this.x_args);if(await this.auth(E,N),this.req.isEventStream&&typeof E.eventStream==="function")return this.push(await this.estream(this.req,E,N));else if(typeof E[this.method]==="function"){let G=await E[this.method](N),{header:V,status:Z,head:B,lang:M}=E;if(this.X.header=V,G)if(this.method==="post"&&G instanceof IQ)return this.push(await this.jwt(G),Z);else if(x(G)&&"error"in G)this.X.status=G.error;else{let O=E.__session;if(O)await U.session.saveSession(O,this.X.headers);return this.push(await this.ctx(G,m.headstr+I.head(B).join(""),M),Z)}else this.X.status=Z??204}}}return this.push()}}var zQ={async open(Q){let $=Q.data.wclass,{z_args:H,client:E}=Q.data;if($){$.ws=Q;let N=$.id,G=Y(E);if(!(N in E)){let V=G?"joiner":"maker";E[N]={role:V}}if(typeof $.init=="function")await $.init(H);if($.broadcasting)$.ws.subscribe($.path);await $.open()}else Q.close()},async message(Q,$){let H=Q.data.wclass;if(H)await H.message($)},async close(Q,$,H){let E=Q.data.wclass,N=Q.data.client;if(E){if(await E.close($,H),E.broadcasting)E.ws.unsubscribe(E.path);let G=E.id;if(delete N[G],Y(N)===1)d(N).forEach((V,Z)=>{N[V].role="maker"})}}};class m extends g{Q;static headstr="";apt;router;constructor(Q="./",$={}){super();this.dir=Q;this.router=q.init;let H=this.dir+"/.private",{envPath:E,appDir:N,session:G}=$;if(!E)i(H),l(H+"/.env",`SECRET_KEY="${j(20)}"`);this.apt=Q+"/"+(N??"app")+"/",this.router.apt=this.apt,DQ({path:(E?E:H)+"/.env"});let V=G??new qQ({dir:this.dir});U.init(V)}path(Q){return($)=>{return this.router.route=new z({url:Q,_class:$}),$}}file(Q,$={session:!1,preload:!1}){let H=b(Q,"."),E=H.startsWith("/")?H:"/"+H;return this.router.route=new z({url:E,isFile:!0,withSession:$.session,preload:$.preload}),E}wss(Q,$={}){return(E)=>{let N=new z({url:Q,_class:E,isWS:!0});if(N.broadcastWSS=$.broadcast??!1,N.withSession=$.session??!1,$.maxClient)N.maxClient=$.maxClient;return this.router.route=N,E}}folder(Q,$={session:!1}){this.router.folder(Q,$)}folders(...Q){Q.forEach(($)=>{this.router.folder($)})}redirect(Q){return new Response("",{status:302,headers:{Location:Q}})}async serve(Q,$={}){let{url:H,hostname:E,method:N,port:G}=Q;if(N??="GET",E??="127.0.0.1",G??=3000,m.headstr=I.head(this.head).join(""),H){let Z=await(await new u({url:`http://${E}:${G}${H??"/"}`,method:N}).response()).arrayBuffer();Z.byteLength&&KQ(this.apt+"index.html",MQ(Z))}else OQ({port:G,tls:a.tls(this.dir),...E&&{hostname:E},fetch:async(V,Z)=>{return await new u(V,Z).response()},websocket:{sendPings:!0,perMessageDeflate:!0,...$,...zQ},...Q})}}export{LQ as wss,gQ as session,AQ as response,vQ as jwt_refresh,mQ as jwt,S as Render,m as Lycaon,YQ as $$};
